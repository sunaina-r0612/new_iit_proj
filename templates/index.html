{% extends 'layout.html' %}

{% block title %}
    Home - Library
{% endblock %}

{% block content %}
<br>
<form id="searchForm" class="d-flex" role="search"> <!-- Added ID to the form -->
    <input id="searchInput" class="form-control me-2" type="search" placeholder="Search" aria-label="Search"> <!-- Added ID to the input -->
    <button class="btn btn-success" type="submit">Search</button>
</form>
<br>
<h2 class="display-2 text-center"><b>Books</b></h2>
<hr>
<div class="categories-list">
    {% for sec in sections %}
    <div class="section" id="section_{{ sec.id }}">
        <h2 class="text-center"><strong>{{ sec.name }}</strong></h2>
        <div class="book">
            {% for b in sec.bookname %}
            <div class="card row col-sm-6 mb-3 mb-sm-0" style="width: 18rem;">
                <div class="card-body">
                    <h5 class="card-title text-center">{{ b.name }}</h5>
                    <p class="card-text">
                        <div class="price">
                            <strong>Name:</strong>
                            {{ b.name }}
                        </div>
                        <div class="quantity">
                            <strong>Author:</strong>
                            {{ b.author }}
                        </div>
                        <div>
                            <strong>Status:</strong>
                            {{ b.status }}
                        </div>
                        <div>
                            <strong>Description:</strong>
                            {{ b.content }}
                        </div>
                        <div class="man_date">
                            <strong>Action:</strong>
                            <form id="bookForm_{{ b.id }}" method="post" action="">
                                <input type="hidden" name="book_id" value="{{ b.id }}">
                                <input type="hidden" name="status" value="{{ b.status }}">
                                
                                {% if b.status == 'Available' or b.status == 'Requested' %}
                                    <button type="button" class="btn btn-primary" onclick="requestBook('{{ b.id }}', '{{ b.status }}')" {% if b.status == 'Issued' %}disabled{% endif %}>Request</button>
                                {% elif b.status == 'Issued' %}
                                    <button type="button" class="btn btn-primary" onclick="returnBook('{{ b.id }}', '{{ b.status }}')">Return</button>
                                {% endif %}
                            </form>                          
                        </div>                    
                    </p>
                </div>
            </div>
            {% endfor %}
            <br>
            <hr>
            <br>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block style %}
<style>
    .categories-list {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .book {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }
    .card {
        margin: 10px;
    }
</style>
{% endblock %}

{% block script %}
<script>
    function requestBook(bookId, status) {
        var form = document.getElementById('bookForm_' + bookId);
        form.action = "{{ url_for('request_book') }}";
        form.elements["status"].value = status; // Set the status value
        form.submit();
    }
    
    function returnBook(bookId, status) {
        var form = document.getElementById('bookForm_' + bookId);
        form.action = "{{ url_for('return_book') }}"; // Set the action to the return_book route
        form.elements["status"].value = status; // Set the status value
        form.submit();
    }    

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelector('#searchForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission
            var searchValue = document.querySelector('#searchInput').value.trim().toLowerCase(); // Get search input value
            var sections = document.querySelectorAll('.section'); // Select all sections
            
            if (searchValue === "") {
                sections.forEach(function(section) {
                    section.style.display = 'block'; // Show all sections if search input is empty
                    section.querySelectorAll('.card').forEach(function(card) {
                        card.style.display = 'block'; // Show all books within the section
                    });
                });
                return; // Exit function if search input is empty
            }

            sections.forEach(function(section) {
                var sectionName = section.querySelector('h2').textContent.toLowerCase();
                var sectionMatches = sectionName.includes(searchValue);
                var books = section.querySelectorAll('.card');

                if (sectionMatches) {
                    section.style.display = 'block'; // Show section if it matches search criteria
                } else {
                    section.style.display = 'none'; // Hide section if it doesn't match search criteria
                }

                books.forEach(function(bookCard) {
                    var bookName = bookCard.querySelector('.card-title').textContent.toLowerCase();
                    var bookParent = bookCard.closest('.card');
                    if (bookName.includes(searchValue) || sectionMatches) {
                        bookParent.style.display = 'block'; // Show book if it matches search criteria or if its section matches
                    } else {
                        bookParent.style.display = 'none'; // Hide book if it doesn't match search criteria and its section doesn't match
                    }
                });
            });
        });
    });
</script>
{% endblock %}
